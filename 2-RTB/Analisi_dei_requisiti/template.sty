\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{template}[2014/08/21 Example package]

\RequirePackage{enumitem}
\RequirePackage{xltabular}
\RequirePackage{etoolbox}
\RequirePackage{xstring}
\RequirePackage{xparse}
\RequirePackage{xspace}

% \newcount\UC@depth
% \newcommand{\UCcountdepth}[1]{%
%     \StrCount{#1}{.}[\UC@depth]%
% }

% ------------------------
% Costanti
% ------------------------
\newcommand{\user}{Utente\xspace}
\newcommand{\os}{Operatore Sanitario\xspace}
\newcommand{\admin}{Amministratore\xspace}
\newcommand{\db}{Database\xspace}
\newcommand{\cloud}{Cloud Vimar\xspace}
\newcommand{\capitolato}{\href{https://www.math.unipd.it/~tullio/IS-1/2025/Progetto/C9.pdf}{Capitolato C9 Vimar}}

% ------------------------
% Liste
% ------------------------

\newcounter{numAtt}
\setcounter{numAtt}{0}
\newcommand{\listaAttori}{}
\newcommand{\addAttore}[1]{
    \stepcounter{numAtt}%
    \gappto{\listaAttori}{\item #1}
}
%=============================
\newcounter{numAttSec}
\setcounter{numAttSec}{0}
\newcommand{\listaAttoriSec}{}
\newcommand{\addAttoreSec}[1]{
    \stepcounter{numAttSec}%
    \gappto{\listaAttoriSec}{\item #1}
}
%=============================
\newcounter{numPre}
\setcounter{numPre}{0}
\newcommand{\listaPreCondizioni}{}
\newcommand{\addPrC}[1]{
    \stepcounter{numPre}%
    \gappto{\listaPreCondizioni}{\item #1}
}
%=============================
\newcounter{numPost}
\setcounter{numPost}{0}
\newcommand{\listaPostCondizioni}{}
\newcommand{\addPoC}[1]{
    \stepcounter{numPost}%
    \gappto{\listaPostCondizioni}{\item #1}
}
%=============================
\newcommand{\listaTrigger}{}
\newcommand{\addTrigger}[1]{
    \gappto{\listaTrigger}{\item #1}
}
%=============================
\newcounter{numSpr}
\setcounter{numSpr}{0}
\newcommand{\listaScenarioPrincipale}{}
\newcommand{\addScenarioPrincipale}[1]{
    \stepcounter{numSpr}%
    \gappto{\listaScenarioPrincipale}{\item #1}
}
%=============================
\newcounter{numInc}
\setcounter{numInc}{0}
\newcommand{\listaInclusioni}{}
\newcommand{\addInclusione}[1]{
    \stepcounter{numInc}%
    \gappto{\listaInclusioni}{\item #1}%
}
%=============================
\newcommand{\listaScenariAlternativi}{}
\newcommand{\addScenarioAlternativo}[1]{
    \gappto{\listaScenariAlternativi}{\item #1}
}
%=============================
\newcommand{\listaEstensioni}{}
\newcommand{\addEstensione}[1]{
    \gappto{\listaEstensioni}{\item #1}
}
%=============================
\newcommand{\listaGeneralizzazioni}{}
\newcommand{\addGeneralizzazione}[1]{
    \gappto{\listaGeneralizzazioni}{\item #1}
}
%=============================
\newcommand{\rif}[1]{%
  \hyperref[UC#1]{UC#1 }\S\ref{UC#1}%
}
%=============================

\NewDocumentCommand{\makeUC}{O{0.5} O{0.5} O{0.5} m m}{%
    \subsubsection{UC#4\ #5}
    \label{UC#4}

    \IfFileExists{./img/UC#4.pdf}{%
        \begin{center}
        \includegraphics[width=#1\textwidth]{./img/UC#4.pdf}
        \captionof{figure}{UC#4 #5}
        \end{center}
    }{}%
    \begin{xltabular}{\textwidth}{|>{\columncolor{lightgray}}c|X|}
    \hline
        % Attori
        \ifdefempty{\listaAttori}{}{%
            \textbf{Attori} &
            \ifnum\value{numAtt}=1
                \parbox[t]{\linewidth}{
                    \vspace*{-10pt}
                    \begin{itemize}[
                        topsep=0pt,
                        partopsep=0pt,
                        itemsep=0pt,
                        leftmargin=2pt,
                        label={}
                        ]
                        \item \listaAttori
                    \end{itemize}
                    \vspace*{6pt}
                }
            \else
                \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaAttori
                \end{itemize}
            \fi
            \\ \hline
        }%

        % Attori secondari
        \ifdefempty{\listaAttoriSec}{}{%
            \textbf{Attori secondari} &
            \ifnum\value{numAttSec}=1
                \parbox[t]{\linewidth}{
                    \vspace*{-10pt}
                    \begin{itemize}[
                        topsep=0pt,
                        partopsep=0pt,
                        itemsep=0pt,
                        leftmargin=2pt,
                        label={}
                        ]
                        \item \listaAttoriSec
                    \end{itemize}
                    \vspace*{6pt}
                }
            \else
                \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaAttoriSec
                \end{itemize}
            \fi
            \\ \hline
        }%

        % Pre-condizioni
        \ifdefempty{\listaPreCondizioni}{}{%
            \textbf{Pre-condizioni} &
            \ifnum\value{numPre}=1
                \parbox[t]{\linewidth}{
                    \vspace*{-10pt}
                    \begin{itemize}[
                        topsep=0pt,
                        partopsep=0pt,
                        itemsep=0pt,
                        leftmargin=2pt,
                        label={}
                        ]
                        \item \listaPreCondizioni
                    \end{itemize}
                    \vspace*{6pt}
                }
            \else
                \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaPreCondizioni
                \end{itemize}
            \fi
            \\ \hline
        }%

        % Post-condizioni
        \ifdefempty{\listaPostCondizioni}{}{%
            \textbf{Post-condizioni} &
            \ifnum\value{numPost}=1
                \parbox[t]{\linewidth}{
                    \vspace*{-10pt}
                    \begin{itemize}[
                        topsep=0pt,
                        partopsep=0pt,
                        itemsep=0pt,
                        leftmargin=2pt,
                        label={}
                        ]
                        \item \listaPostCondizioni
                    \end{itemize}
                    \vspace*{6pt}
                }
            \else
                \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaPostCondizioni
                \end{itemize}
            \fi
            \\ \hline
        }%

        % Trigger
        %\ifdefempty{\listaTrigger}{}{%
        %    \textbf{Trigger} &
        %    \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
        %         \listaTrigger
        %    \end{itemize}\\ \hline
        %}%

        % Scenario principale (enumerato)
        \ifdefempty{\listaScenarioPrincipale}{}{%
            \textbf{Scenario principale} &
            \ifnum\value{numSpr}=1
                \parbox[t]{\linewidth}{
                    \vspace*{-10pt}
                    \begin{itemize}[
                        topsep=0pt,
                        partopsep=0pt,
                        itemsep=0pt,
                        leftmargin=2pt,
                        label={}
                        ]
                        \item \listaScenarioPrincipale
                    \end{itemize}
                    \vspace*{6pt}
                }
            \else
                \begin{enumerate}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=12pt]
                \listaScenarioPrincipale
                \end{enumerate}
            \fi
            \\ \hline
        }%

        % Inclusioni
        \ifdefempty{\listaInclusioni}{}{%
            \textbf{Inclusioni} &
            \ifnum\value{numInc}=1
                \parbox[t]{\linewidth}{
                    \vspace*{-10pt}
                    \begin{itemize}[
                        topsep=0pt,
                        partopsep=0pt,
                        itemsep=0pt,
                        leftmargin=2pt,
                        label={}
                        ]
                        \item \listaInclusioni
                    \end{itemize}
                    \vspace*{6pt}
                }
            \else
                \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaInclusioni
                \end{itemize}
            \fi
            \\ \hline
        }

        % Scenari alternativi
        \ifdefempty{\listaScenariAlternativi}{}{%
            \textbf{Scenari alternativi} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaScenariAlternativi
            \end{itemize}\\ \hline
        }%

        % Estensioni
        \ifdefempty{\listaEstensioni}{}{%
            \textbf{Estensioni} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaEstensioni
            \end{itemize}\\ \hline
        }%

        % Generalizzazioni
        \ifdefempty{\listaGeneralizzazioni}{}{%
            \textbf{Generalizzazioni} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaGeneralizzazioni
            \end{itemize}\\ \hline
        }%
    \end{xltabular}

    \IfFileExists{./img/UC#4i.pdf}{%
        \begin{center}
        \includegraphics[width=#2\textwidth]{./img/UC#4i.pdf}
        \captionof{figure}{Inclusioni dell'UC#4}
        \end{center}
    }{}%

    \IfFileExists{./img/UC#4g.pdf}{%
        \begin{center}
        \includegraphics[width=#3\textwidth]{./img/UC#4g.pdf}
        \captionof{figure}{Generalizzazione dell'UC#4}
        \end{center}
    }{}%

    % Pulisce le variabili per riempire la prossima tabella
    \renewcommand{\listaAttori}{}
    \renewcommand{\listaAttoriSec}{}
    \renewcommand{\listaPreCondizioni}{}
    \renewcommand{\listaPostCondizioni}{}
    \renewcommand{\listaTrigger}{}
    \renewcommand{\listaScenarioPrincipale}{}
    \renewcommand{\listaScenariAlternativi}{}
    \renewcommand{\listaInclusioni}{}
    \renewcommand{\listaEstensioni}{}
    \renewcommand{\listaGeneralizzazioni}{}
    \setcounter{numAtt}{0}
    \setcounter{numAttSec}{0}
    \setcounter{numPost}{0}
    \setcounter{numPre}{0}
    \setcounter{numSpr}{0}
    \setcounter{numInc}{0}
}

% --- Req funzionali ---

\newcommand{\reqFEntries}{}
\newcounter{refctr}
\newcounter{refobctr}
\newcounter{refdectr}
\newcounter{refopctr}
\newcommand{\addReqF}[3]{%
  \begingroup
    \stepcounter{refctr}
    \edef\RF@id{\therefctr}

    % determinazione del tipo
    \def\RF@type{??}%
    \ifnum#1=2
      \stepcounter{refobctr}\def\RF@type{OB}%
    \else\ifnum#1=1
      \stepcounter{refdectr}\def\RF@type{DE}%
    \else\ifnum#1=0
      \stepcounter{refopctr}\def\RF@type{OP}%
    \fi\fi\fi

    % costruzione sicura della riga
    \edef\@tempa{%
      \noexpand\gappto\noexpand{\noexpand\reqFEntries}{%
        RF\RF@id-\RF@type
        & \unexpanded{#2}
        & \noexpand\parbox[t]{\noexpand\linewidth}{\unexpanded{#3}}
        \\ \noexpand\hline
      }%
    }%
    \@tempa
  \endgroup
}

\newcommand{\makeReqFtable}{
    \subsection{Funzionali}{
        \renewcommand{\arraystretch}{1.25}
        \begin{center}
            \begin{xltabular}{\textwidth}{|c|X|p{3.40cm}|}
            \hline
            \rowcolor{lightgray} \textbf{Id} & \textbf{Descrizione} & \textbf{Fonti} \\
            \hline
            \reqFEntries
            \end{xltabular}
        \end{center}
    }
}

% --- Req di qualità ---

\newcommand{\reqQEntries}{}
\newcounter{reqctr}
\newcounter{reqobctr}
\newcounter{reqdectr}
\newcounter{reqopctr}
\newcommand{\addReqQ}[3]{%
  \begingroup
    \stepcounter{reqctr}
    \edef\RQ@id{\thereqctr}

    % determinazione del tipo (solo logica)
    \def\RQ@type{??}%
    \ifnum#1=2
      \stepcounter{reqobctr}\def\RQ@type{OB}%
    \else\ifnum#1=1
      \stepcounter{reqdectr}\def\RQ@type{DE}%
    \else\ifnum#1=0
      \stepcounter{reqopctr}\def\RQ@type{OP}%
    \fi\fi\fi

    % solo testo nell'edef
    \edef\@tempa{%
      \noexpand\gappto\noexpand{\noexpand\reqQEntries}{%
        RQ\RQ@id-\RQ@type
        & \unexpanded{#2}
        & \noexpand\parbox[t]{\noexpand\linewidth}{\unexpanded{#3}}
        \\ \noexpand\hline
      }%
    }%
    \@tempa
  \endgroup
}


\newcommand{\makeReqQtable}{
    \subsection{Di qualità}{
        \renewcommand{\arraystretch}{1.25}
        \begin{center}
            \begin{xltabular}{\textwidth}{|c|X|p{3.85cm}|}
            \hline
            \rowcolor{lightgray} \textbf{Id} & \textbf{Descrizione} & \textbf{Fonti} \\
            \hline
            \reqQEntries
            \end{xltabular}
        \end{center}
    }
}

% --- Req di vincolo ---

\newcommand{\reqVEntries}{}
\newcounter{revctr}
\newcounter{revobctr}
\newcounter{revdectr}
\newcounter{revopctr}
\newcommand{\addReqV}[3]{%
  \begingroup
    \stepcounter{revctr}
    \edef\RV@id{\therevctr}

    % gestione contatori
    \def\RV@type{??}%
    \ifnum#1=2
      \stepcounter{revobctr}\def\RV@type{OB}%
    \else\ifnum#1=1
      \stepcounter{revdectr}\def\RV@type{DE}%
    \else\ifnum#1=0
      \stepcounter{revopctr}\def\RV@type{OP}%
    \fi\fi\fi

    % solo testo nell'edef
    \edef\@tempa{%
      \noexpand\gappto\noexpand{\noexpand\reqVEntries}{%
        RV\RV@id-\RV@type
        & \unexpanded{#2}
        & \unexpanded{#3}
        \\ \noexpand\hline
      }%
    }%
    \@tempa
  \endgroup
}


\newcommand{\makeReqVtable}{
    \subsection{Di vincolo}{
        \renewcommand{\arraystretch}{1.25}
        \begin{center}
            \begin{xltabular}{\textwidth}{|c|X|c|}
            \hline
            \rowcolor{lightgray} \textbf{Id} & \textbf{Descrizione} & \textbf{Fonti} \\
            \hline
            \reqVEntries
            \end{xltabular}
        \end{center}
    }
}

\newcommand{\makeSummaryTable}{
    \subsection{Riepilogo}{
        \renewcommand{\arraystretch}{1.25}
        \begin{center}
            \begin{xltabular}{\textwidth}{|c|c|c|c|c|}
            \hline
            \rowcolor{lightgray} \textbf{Tipi di requisito} & \textbf{obbligatori} & \textbf{desiderabili} & \textbf{opzionali} & \textbf{totali} \\
            \hline
            funzionali & \therefobctr & \therefdectr & \therefopctr & \therefctr \\
            \hline
            di qualità & \thereqobctr & \thereqdectr & \thereqopctr & \thereqctr \\
            \hline
            di vincolo & \therevobctr & \therevdectr & \therevopctr & \therevctr \\
            \hline
            \end{xltabular}
        \end{center}
    }
}