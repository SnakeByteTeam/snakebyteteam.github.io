\NeedsTeXFormat{LaTeX2e}
\ProvidesPackage{template}[2014/08/21 Example package]

\RequirePackage{enumitem}
\RequirePackage{xltabular}
\RequirePackage{etoolbox}
\RequirePackage{xstring}

\newcount\UC@depth
\newcommand{\UCcountdepth}[1]{%
    \StrCount{#1}{.}[\UC@depth]%
}

% ------------------------
% Livello profondità sezioni
% ------------------------

\newcommand{\UCtoclevel}{subsubsection}

\newcommand{\UCsettoclevel}{%
    \ifcase\UC@depth
        \def\UCtoclevel{subsubsection}% UC1
    \or
        \def\UCtoclevel{paragraph}% UC1.1
    \or
        \def\UCtoclevel{subparagraph}% UC1.1.1
    \else
        \def\UCtoclevel{subparagraph}% UC1.1.1.x...
    \fi
}

% ------------------------
% Costanti
% ------------------------
\newcommand{\user}{Utente }
\newcommand{\userna}{Utente non autenticato }
\newcommand{\os}{Operatore Sanitario }
\newcommand{\admin}{Amministratore }

% ------------------------
% Liste
% ------------------------

\newcommand{\listaAttori}{}
\newcommand{\addAttore}[1]{
    \gappto{\listaAttori}{\item #1}
}
%=============================
\newcommand{\listaPreCondizioni}{}
\newcommand{\addPreCondizione}[1]{
    \gappto{\listaPreCondizioni}{\item #1}
}
%=============================
\newcommand{\listaPostCondizioni}{}
\newcommand{\addPostCondizione}[1]{
    \gappto{\listaPostCondizioni}{\item #1}
}
%=============================
\newcommand{\listaTrigger}{}
\newcommand{\addTrigger}[1]{
    \gappto{\listaTrigger}{\item #1}
}
%=============================
\newcommand{\listaScenarioPrincipale}{}
\newcommand{\addScenarioPrincipale}[1]{
    \gappto{\listaScenarioPrincipale}{\item #1}
}
%=============================
\newcommand{\listaInclusioni}{}
\newcommand{\addInclusione}[1]{
    \gappto{\listaInclusioni}{\item #1}
}
%=============================
\newcommand{\listaScenariAlternativi}{}
\newcommand{\addScenarioAlternativo}[1]{
    \gappto{\listaScenariAlternativi}{\item #1}
}
%=============================
\newcommand{\listaEstensioni}{}
\newcommand{\addEstensione}[1]{
    \gappto{\listaEstensioni}{\item #1}
}
%=============================
\newcommand{\rif}[1]{\hyperref[UC#1]{§UC#1}}
%=============================

\newcommand{\makeUC}[2]{%
    \label{UC#1}
    \UCcountdepth{#1}%
    \UCsettoclevel%
    
    \phantomsection
    \subsubsection*{UC#1:\ #2}%
    \addcontentsline{toc}{\UCtoclevel}{UC#1:\ #2}%

    \IfFileExists{./img/UC#1.pdf}{%
        \begin{center}
        \includegraphics[width=\textwidth]{./img/UC#1.pdf}
        \captionof{figure}{UC#1 #2}
        \end{center}
    }{}%
    \begin{xltabular}{\textwidth}{|>{\columncolor{lightgray}}c|X|}
    \hline
        % Attori
        \ifdefempty{\listaAttori}{}{%
            \textbf{Attori} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaAttori
            \end{itemize}\\ \hline
        }%

        % Pre-condizioni
        \ifdefempty{\listaPreCondizioni}{}{%
            \textbf{Pre-condizioni} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaPreCondizioni
            \end{itemize}\\ \hline
        }%

        % Post-condizioni
        \ifdefempty{\listaPostCondizioni}{}{%
            \textbf{Post-condizioni} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaPostCondizioni
            \end{itemize}\\ \hline
        }%

        % Trigger
        \ifdefempty{\listaTrigger}{}{%
            \textbf{Trigger} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaTrigger
            \end{itemize}\\ \hline
        }%

        % Scenario principale (enumerato)
        \ifdefempty{\listaScenarioPrincipale}{}{%
            \textbf{Scenario principale} &
            \begin{enumerate}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=15pt]
                \listaScenarioPrincipale
            \end{enumerate}\\ \hline
        }%

        % Inclusioni
        \ifdefempty{\listaInclusioni}{}{%
            \textbf{Inclusioni} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaInclusioni
            \end{itemize}\\ \hline
        }%

        % Scenari alternativi
        \ifdefempty{\listaScenariAlternativi}{}{%
            \textbf{Scenari alternativi} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaScenariAlternativi
            \end{itemize}\\ \hline
        }%

        % Estensioni
        \ifdefempty{\listaEstensioni}{}{%
            \textbf{Estensioni} &
            \begin{itemize}[topsep=0pt, partopsep=0pt, itemsep=0pt, leftmargin=10pt]
                \listaEstensioni
            \end{itemize}\\ \hline
        }%
    \end{xltabular}

    % Pulisce le variabili per riempire la prossima tabella
    \renewcommand{\listaAttori}{}
    \renewcommand{\listaPreCondizioni}{}
    \renewcommand{\listaPostCondizioni}{}
    \renewcommand{\listaTrigger}{}
    \renewcommand{\listaScenarioPrincipale}{}
    \renewcommand{\listaScenariAlternativi}{}
    \renewcommand{\listaInclusioni}{}
    \renewcommand{\listaEstensioni}{}
}